<html>
	<head>
		<title>Background</title>
		<style>
			canvas {
				position: absolute;
				top: 0px;
				left: 0px;
				background: transparent;
			}
			#myCanvas {
				z-index: -2;
			}
			
			#ship {
				z-index: 0;
			}
		</style>
	</head>
	<body onload="init()">
		<canvas id="myCanvas" width="600" height="360"></canvas>
		<canvas id="ship" width="600" height="360"></canvas>
		<script>
			
			var game = new Game();
            
            function init() {
                if (game.init()) {
                    game.start();
                }
            }
            
            var imageRepository = new function() {
                this.empty = null;
                this.background = new Image();
                this.background.src = "img/bg.png";
                this.spaceship = new Image();
                this.spaceship.src = "img/ship.png";
            };
			
            function Drawable() {
                this.init = function(x, y, width, height) {
                    this.x = x;
                    this.y = y;
                    this.width = width;
                    this.height = height;
                };
                
                this.speed = 0;
                this.canvasWidth = 0;
                this.canvasHeight = 0;
                
                this.draw = function() {
                };
                
                this.move = function() {
                };
            }
            
            function Background() {
                this.speed = 1;
                this.draw = function() {
                    this.y += this.speed;
                    this.context.drawImage(imageRepository.background, this.x, this.y);
                    this.context.drawImage(imageRepository.background, this.x, this.y - this.canvasHeight);
                    
                    if (this.y >= this.canvasHeight) {
                        this.y = 0;
                    }
                };
            }
            
            Background.prototype = new Drawable();
            
            function Ship() {
                this.speed = 3;
                this.draw = function() {
                    this.context.drawImage(imageRepository.spaceship, this.x, this.y);
                };
                
                this.move = function() {
                    if (KEY_STATUS.left || KEY_STATUS.right || KEY_STATUS.down || KEY_STATUS.up) {
                        
                        this.context.clearRect(this.x, this.y, this.width, this.height);
                        
                        if (KEY_STATUS.left) {
                            this.x -= this.speed;
                            if (this.x <= 0) {
                                this.x = 0;
                            } 
                        } else if (KEY_STATUS.right) {
                            this.x += this.speed;
							if (this.x >= this.shipWidth - this.width) {
								this.x = this.shipWidth - this.width;
							}
                        } else if (KEY_STATUS.up) {
							this.y -= this.speed;
							if (this.y <= 0) {
								this.y = 0;
							}
						} else if (KEY_STATUS.down) {
							this.y += this.speed;
							if (this.y >= this.shipHeight - this.height) {
								this.y = this.shipHeight - this.height;
							}
						}
                        
                        this.draw();
                    }
                };
            }
            
            Ship.prototype = new Drawable();
            
            function Game() {
                this.init = function() {
                    this.canvas = document.getElementById("myCanvas");
                    this.shipCanvas = document.getElementById("ship");
                    if (this.canvas.getContext && this.shipCanvas.getContext) {
                        this.bgContext = this.canvas.getContext("2d");
                        this.shipContext = this.shipCanvas.getContext("2d");
                        
                        Background.prototype.context = this.bgContext;
                        Background.prototype.canvasWidth = this.canvas.width;
                        Background.prototype.canvasHeight = this.canvas.height;
                        
                        Ship.prototype.context = this.shipContext;
                        Ship.prototype.shipWidth = this.shipCanvas.width;
                        Ship.prototype.shipHeight = this.shipCanvas.height;
                        
                        this.background = new Background();
                        this.background.init(0,0);
                        
                        this.ship =  new Ship();
                        var shipStartX = this.shipCanvas.width / 2 - imageRepository.spaceship.width / 2;
                        var shipStartY = this.shipCanvas.height / 4*3 + imageRepository.spaceship.height * 2;
                       
                        this.ship.init(shipStartX, shipStartY, imageRepository.spaceship.width, imageRepository.spaceship.height);
                        return true;
                    } else {
                        return false;
                    }
                };
                
                this.start = function() {
                    this.ship.draw();
                    animate();
                };
            }
            
            function animate() {
                requestAnimationFrame(animate);
                game.background.draw();
                game.ship.move();
                
            }
            
            
            KEY_CODES = {
                32: 'space',
                37: 'left',
                38: 'up',
                39: 'right',
                40: 'down'
            };
            
            KEY_STATUS = {};
            for (code in KEY_CODES) {
                KEY_STATUS[KEY_CODES[code]] = false;
            }
            
            document.onkeydown =  function(e) {
                var keyCode = (e.keyCode) ? e.keyCode : e.charCode;
                if (KEY_CODES[keyCode]) {
                    e.preventDefault();
                    KEY_STATUS[KEY_CODES[keyCode]] = true;
                }
            }
            
            document.onkeyup = function(e) {
                var keyCode = (e.keyCode) ? e.keyCode : e.charCode;
                if (KEY_CODES[keyCode]) {
                    e.preventDefault();
                    KEY_STATUS[KEY_CODES[keyCode]] = false;
                }
            }
            
            window.requestAnimationFrame = (function() {
                return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    function(callback, element) {
                        window.setTimeout(callback, 1000 / 60);
                    };
            })();
            
		</script>
	</body>
</html>